<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnLens PDF Chat</title>
    <link rel="stylesheet" href="https://static.testpress.in/static/learnlens/lib/learnlens-pdfchat.css">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #learnlens-pdf-chat { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div class="hs-overlay-layout-open:pe-96 transition-all duration-300" id="learnlens-pdf-chat"></div>
    <script src="https://static.testpress.in/static/learnlens/lib/learnlens-pdfchat.iife.js"></script>
    <script>
        let isInitialized = false;
        let pendingAnnotations = null;
        
        window.setAnnotationsForLearnLens = function(bookmarks) {
            pendingAnnotations = { bookmarks: bookmarks || [] };
            
            if (!isInitialized && window.LearnLens && window.LearnLens.mountPdfChat) {
                initLearnLens();
            } else if (isInitialized && window.LearnLens && window.LearnLens.setAnnotations) {
                try {
                    window.LearnLens.setAnnotations([], pendingAnnotations.bookmarks);
                } catch (e) {
                    console.error("[Template] LearnLens.setAnnotations failed:", e);
                }
            } else {
                console.log("[Template] Conditions not met - isInitialized:", isInitialized, "hasLearnLens:", !!window.LearnLens, "hasMountPdfChat:", !!(window.LearnLens && window.LearnLens.mountPdfChat), "hasSetAnnotations:", !!(window.LearnLens && window.LearnLens.setAnnotations));
            }
        };
        
        const templateBookmarks = {{INITIAL_BOOKMARKS_JSON}} || [];
        
        function initLearnLens() {
            if (isInitialized) {
                return;
            }
            
            if (window.LearnLens && window.LearnLens.mountPdfChat) {
                isInitialized = true;
                
                const initialBookmarks = (pendingAnnotations && pendingAnnotations.bookmarks) ? pendingAnnotations.bookmarks : templateBookmarks;
                
                window.LearnLens.mountPdfChat("learnlens-pdf-chat", {
                    pdfUrl: "{{PDF_URL}}",
                    pdfId: "{{PDF_ID}}",
                    authToken: "{{AUTH_TOKEN}}",
                    pdfTitle: "{{PDF_TITLE}}",
                    initialBookmarks: initialBookmarks,
                    onBookmarkCreate: function(page, previewText) {
                        const promise = new Promise(function(resolve, reject) {
                            if (!window.AndroidBridge || !window.AndroidBridge.onBookmarkCreate) {
                                reject(new Error('Android bridge not available'));
                                return;
                            }
                            
                            const bookmarkToSend = {
                                page_number: page,
                                preview_text: previewText || ''
                            };
                            
                            const successHandler = function(createdBookmark) {
                                if (createdBookmark && createdBookmark.id) {
                                    resolve(createdBookmark);
                                } else {
                                    reject(new Error('Bookmark created but ID is missing'));
                                }
                            };
                            
                            const errorHandler = function(error) {
                                reject(new Error(error.error || 'Failed to create bookmark'));
                            };
                            
                            window.LearnLens.onBookmarkCreateSuccess = successHandler;
                            window.LearnLens.onBookmarkCreateError = errorHandler;
                            
                            window.AndroidBridge.onBookmarkCreate(JSON.stringify(bookmarkToSend));
                        });

                        return promise
                            .then(function(result) {
                                return result;
                            })
                            .finally(function() {
                                delete window.LearnLens.onBookmarkCreateSuccess;
                                delete window.LearnLens.onBookmarkCreateError;
                            });
                    },
                    onBookmarkDelete: function(bookmarkId) {
                        if (window.AndroidBridge && window.AndroidBridge.onBookmarkDelete) {
                            window.AndroidBridge.onBookmarkDelete(bookmarkId);
                        }
                    }
                });
            }
        }
        
        function tryInitLearnLens() {
            if (window.LearnLens && window.LearnLens.mountPdfChat) {
                initLearnLens();
            } else {
                let pollAttempts = 0;
                const MAX_POLL_ATTEMPTS = 20;
                const pollInterval = setInterval(function() {
                    pollAttempts++;
                    if (window.LearnLens && window.LearnLens.mountPdfChat) {
                        clearInterval(pollInterval);
                        initLearnLens();
                    } else if (pollAttempts >= MAX_POLL_ATTEMPTS) {
                        clearInterval(pollInterval);
                        console.error(
                            "LearnLens library failed to load after " +
                            (MAX_POLL_ATTEMPTS * 100 / 1000) +
                            " seconds"
                        );
                        initLearnLens();
                    }
                }, 100);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            tryInitLearnLens();
        });
    </script>
</body>
</html>


