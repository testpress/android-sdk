<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnLens PDF Chat</title>
    <link rel="stylesheet" href="https://static.testpress.in/static/learnlens/lib/learnlens-pdfchat.css">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #learnlens-pdf-chat { width: 100%; height: 100vh; }
    </style>
</head>
<body>
    <div class="hs-overlay-layout-open:pe-96 transition-all duration-300" id="learnlens-pdf-chat"></div>
    <script src="https://static.testpress.in/static/learnlens/lib/learnlens-pdfchat.iife.js"></script>
    <script>
        let isInitialized = false;
        let pendingAnnotations = null;
        
        window.setAnnotationsForLearnLens = function(bookmarks) {
            pendingAnnotations = { bookmarks: bookmarks || [] };
            
            if (!isInitialized && window.LearnLens && window.LearnLens.mountPdfChat) {
                initLearnLens();
            } else if (isInitialized && window.LearnLens && window.LearnLens.setAnnotations) {
                try {
                    window.LearnLens.setAnnotations([], pendingAnnotations.bookmarks);
                } catch (e) {
                    console.error("[Template] LearnLens.setAnnotations failed:", e);
                }
            }
        };
        
        function tryLearnLensApi(pageNumber) {
            if (!window.LearnLens) return '';
            
            try {
                if (typeof window.LearnLens.getPageText === 'function') {
                    return window.LearnLens.getPageText(pageNumber) || '';
                }
                if (typeof window.LearnLens.getTextContent === 'function') {
                    return window.LearnLens.getTextContent(pageNumber) || '';
                }
                if (window.LearnLens.pdfViewer && typeof window.LearnLens.pdfViewer.getPageText === 'function') {
                    return window.LearnLens.pdfViewer.getPageText(pageNumber) || '';
                }
            } catch (e) {
                console.error("tryLearnLensApi failed for page", pageNumber, ":", e);
            }
            return '';
        }
        
        function findPageElement(pdfViewer, pageNumber) {
            const selectors = [
                '[data-page-number="' + pageNumber + '"]',
                '[data-page="' + pageNumber + '"]',
                '[data-page-index="' + (pageNumber - 1) + '"]',
                '.page[data-page-number="' + pageNumber + '"]',
                '.page[data-page="' + pageNumber + '"]',
                '.pdfPage[data-page-number="' + pageNumber + '"]',
                'div[data-page-number="' + pageNumber + '"]',
                'section[data-page-number="' + pageNumber + '"]'
            ];
            
            for (let i = 0; i < selectors.length; i++) {
                const element = pdfViewer.querySelector(selectors[i]);
                if (element) return element;
            }
            
            const pageClasses = ['.page', '.pdf-page', '.pdfPage', '.page-container', '[class*="page"]'];
            for (let j = 0; j < pageClasses.length; j++) {
                const pages = pdfViewer.querySelectorAll(pageClasses[j]);
                if (pages.length >= pageNumber) {
                    return pages[pageNumber - 1];
                }
            }
            
            const allDataPages = pdfViewer.querySelectorAll('[data-page-number], [data-page], [data-page-index]');
            for (let k = 0; k < allDataPages.length; k++) {
                const elem = allDataPages[k];
                const pageAttr = elem.getAttribute('data-page-number') || 
                              elem.getAttribute('data-page') || 
                              (elem.getAttribute('data-page-index') ? parseInt(elem.getAttribute('data-page-index'), 10) + 1 : null);
                if (pageAttr == pageNumber || pageAttr == (pageNumber - 1)) {
                    return elem;
                }
            }
            
            return null;
        }
        
        function extractTextFromPageElement(pageElement, pdfViewer) {
            if (pageElement) {
                const textLayer = pageElement.querySelector('.textLayer, .text-layer, .textContent, canvas + div, [class*="text"]');
                if (textLayer) {
                    return textLayer.innerText || textLayer.textContent || '';
                }
                return pageElement.innerText || pageElement.textContent || '';
            }
            
            const allText = pdfViewer.innerText || pdfViewer.textContent || '';
            if (allText && allText.trim().length > 0) {
                return allText.trim().split(/\s+/).slice(0, 20).join(' ');
            }
            return '';
        }
        
        function extractPreviewText(pageNumber) {
            if (!pageNumber) return '';
            
            let text = tryLearnLensApi(pageNumber);
            if (text) return normalizePreviewText(text);
            
            try {
                const pdfViewer = document.querySelector('#learnlens-pdf-chat');
                if (pdfViewer) {
                    const pageElement = findPageElement(pdfViewer, pageNumber);
                    text = extractTextFromPageElement(pageElement, pdfViewer);
                    return normalizePreviewText(text);
                }
            } catch (e) {
                console.error("extractPreviewText failed for page", pageNumber, ":", e);
            }
            
            return '';
        }
        
        function normalizePreviewText(text) {
            if (!text) return '';
            text = text.trim().replace(/\s+/g, ' ');
            if (text.length < 3) return '';
            if (text.length > 100) {
                const truncated = text.substring(0, 100);
                const lastSpace = truncated.lastIndexOf(' ');
                return lastSpace > 50 ? truncated.substring(0, lastSpace) : truncated;
            }
            return text;
        }
        
        function buildBookmarkObject(bookmark, pageNumber, previewText) {
            if (typeof bookmark === 'number') {
                return {
                    page: pageNumber,
                    pageNumber: pageNumber,
                    previewText: previewText,
                    preview_text: previewText
                };
            }
            return Object.assign({}, bookmark, {
                previewText: previewText,
                preview_text: previewText
            });
        }
        
        function initLearnLens() {
            if (isInitialized) {
                return;
            }
            
            if (window.LearnLens && window.LearnLens.mountPdfChat) {
                isInitialized = true;
                
                const initialBookmarks = (pendingAnnotations && pendingAnnotations.bookmarks) ? pendingAnnotations.bookmarks : templateBookmarks;
                
                window.LearnLens.mountPdfChat("learnlens-pdf-chat", {
                    pdfUrl: "{{PDF_URL}}",
                    pdfId: "{{PDF_ID}}",
                    authToken: "{{AUTH_TOKEN}}",
                    pdfTitle: "{{PDF_TITLE}}",
                    initialBookmarks: initialBookmarks,
                    onBookmarkCreate: function(bookmark) {
                        return new Promise(function(resolve, reject) {
                            if (!window.AndroidBridge || !window.AndroidBridge.onBookmarkCreate) {
                                reject(new Error('Android bridge not available'));
                                return;
                            }
                            
                            const pageNumber = typeof bookmark === 'number' ? bookmark : 
                                (bookmark && (bookmark.page || bookmark.pageNumber || bookmark.page_number));
                            const hasPreviewText = bookmark && typeof bookmark === 'object' && 
                                (bookmark.preview_text || bookmark.previewText);
                            
                            let bookmarkToSend = bookmark;
                            if (!hasPreviewText && pageNumber) {
                                const previewText = extractPreviewText(pageNumber);
                                bookmarkToSend = buildBookmarkObject(bookmark, pageNumber, previewText);
                            }
                            
                            const successHandler = function(createdBookmark) {
                                if (createdBookmark && createdBookmark.id) {
                                    resolve(createdBookmark);
                                } else {
                                    reject(new Error('Bookmark created but ID is missing'));
                                }
                            };
                            
                            const errorHandler = function(error) {
                                reject(new Error(error.error || 'Failed to create bookmark'));
                            };
                            
                            window.LearnLens.onBookmarkCreateSuccess = successHandler;
                            window.LearnLens.onBookmarkCreateError = errorHandler;
                            
                            window.AndroidBridge.onBookmarkCreate(JSON.stringify(bookmarkToSend));
                            
                            setTimeout(function() {
                                if (window.LearnLens.onBookmarkCreateSuccess === successHandler) {
                                    delete window.LearnLens.onBookmarkCreateSuccess;
                                }
                                if (window.LearnLens.onBookmarkCreateError === errorHandler) {
                                    delete window.LearnLens.onBookmarkCreateError;
                                }
                            }, 10000);
                        });
                    },
                    onBookmarkDelete: function(bookmarkId) {
                        if (window.AndroidBridge && window.AndroidBridge.onBookmarkDelete) {
                            window.AndroidBridge.onBookmarkDelete(bookmarkId);
                        }
                    }
                });
            }
        }
        
        const templateBookmarks = {{INITIAL_BOOKMARKS_JSON}} || [];
        
        function tryInitLearnLens() {
            if (window.LearnLens && window.LearnLens.mountPdfChat) {
                initLearnLens();
            } else {
                let pollAttempts = 0;
                const MAX_POLL_ATTEMPTS = 20;
                const pollInterval = setInterval(function() {
                    pollAttempts++;
                    if (window.LearnLens && window.LearnLens.mountPdfChat) {
                        clearInterval(pollInterval);
                        initLearnLens();
                    } else if (pollAttempts >= MAX_POLL_ATTEMPTS) {
                        clearInterval(pollInterval);
                        initLearnLens();
                    }
                }, 100);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            tryInitLearnLens();
        });
    </script>
</body>
</html>


